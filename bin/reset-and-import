#!/usr/bin/env bash
set -e

LIMIT=${LIMIT:-10}
USER_EMAIL=${USER_EMAIL:-test@example.com}
USER_PASSWORD=${USER_PASSWORD:-password123}

echo "==> Resetting database..."
bin/rails db:reset

echo "==> Running migrations..."
bin/rails db:migrate

echo "==> Creating user: $USER_EMAIL..."
bin/rails runner "User.create(email_address: '$USER_EMAIL', password: '$USER_PASSWORD').tap { |u| raise u.errors.full_messages.join unless u.persisted? }"

echo "==> Importing $LIMIT emails..."
echo "$USER_EMAIL" | LIMIT=$LIMIT bin/rails import:enrich_contacts

echo "==> Done!"
