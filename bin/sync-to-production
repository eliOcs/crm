#!/usr/bin/env bash
set -euo pipefail

# Sync local data to production server
# Usage: bin/sync-to-production [--dry-run]
#
# Syncs:
# - SQLite database (includes emails table)
# - Active Storage files (company logos, email attachments)

PRODUCTION_HOST="52.30.167.17"
PRODUCTION_USER="root"
REMOTE_STORAGE="/var/lib/docker/volumes/crm_storage/_data"

DRY_RUN=""
if [[ "${1:-}" == "--dry-run" ]]; then
  DRY_RUN="--dry-run"
  echo "==> DRY RUN MODE - no changes will be made"
fi

echo "==> Syncing local data to production ($PRODUCTION_HOST)"
echo ""

# 1. Database (includes emails, contacts, companies, etc.)
echo "==> Syncing database..."
rsync -avz --progress $DRY_RUN \
  storage/development.sqlite3 \
  "$PRODUCTION_USER@$PRODUCTION_HOST:$REMOTE_STORAGE/production.sqlite3"

# 2. Active Storage files (company logos, email attachments)
echo ""
echo "==> Syncing Active Storage files..."
BLOB_COUNT=$(find storage -type f -not -name "*.sqlite3*" 2>/dev/null | wc -l | tr -d ' ')
echo "   Found $BLOB_COUNT Active Storage blobs"
rsync -avz --progress $DRY_RUN \
  --exclude='*.sqlite3' \
  --exclude='*.sqlite3-*' \
  storage/ \
  "$PRODUCTION_USER@$PRODUCTION_HOST:$REMOTE_STORAGE/"

echo ""
echo "==> Sync complete!"
echo ""
echo "Production paths:"
echo "  Database: $REMOTE_STORAGE/production.sqlite3"
echo "  Storage:  $REMOTE_STORAGE/"
echo ""
echo "NOTE: You may need to redeploy for changes to take effect:"
echo "  bin/kamal deploy"
