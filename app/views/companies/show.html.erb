<h1>
  <% if @company.logo.attached? %>
    <%= image_tag @company.logo, style: "max-height: 48px; max-width: 96px; vertical-align: middle;" %>
  <% end %>
  <%= @company.display_name %>
</h1>

<dl>
  <% if @company.commercial_name.present? && @company.legal_name != @company.commercial_name %>
    <dt><strong>Legal Name</strong></dt>
    <dd><%= @company.legal_name %></dd>
  <% end %>

  <% if @company.industry.present? %>
    <dt><strong>Industry</strong></dt>
    <dd><%= @company.industry %></dd>
  <% end %>

  <% if @company.location.present? %>
    <dt><strong>Location</strong></dt>
    <dd><%= @company.location %></dd>
  <% end %>

  <% if @company.website.present? %>
    <dt><strong>Website</strong></dt>
    <dd><%= link_to @company.website, @company.website, target: "_blank" %></dd>
  <% end %>

  <% if @company.description.present? %>
    <dt><strong>Description</strong></dt>
    <dd><%= @company.description %></dd>
  <% end %>

</dl>

<h2>Contacts (<%= @contacts.count %>)</h2>

<% if @contacts.any? %>
  <table>
    <thead>
      <tr>
        <th>Name</th>
        <th>Email</th>
        <th>Job Role</th>
      </tr>
    </thead>
    <tbody>
      <% @contacts.each do |contact| %>
        <tr>
          <td><%= contact.name.presence || "(No name)" %></td>
          <td><%= contact.email %></td>
          <td><%= contact.job_role %></td>
        </tr>
      <% end %>
    </tbody>
  </table>
<% else %>
  <p>No contacts linked to this company yet.</p>
<% end %>

<h2>Audit Log</h2>

<% if @company.audit_logs.any? %>
  <table>
    <thead>
      <tr>
        <th>Date</th>
        <th>Action</th>
        <th>Message</th>
        <th>Source</th>
        <th>Changes</th>
      </tr>
    </thead>
    <tbody>
      <% @company.audit_logs.order(created_at: :desc).each do |log| %>
        <tr>
          <td><%= log.created_at.strftime("%Y-%m-%d %H:%M") %></td>
          <td><%= log.action %></td>
          <td><%= log.message %></td>
          <td>
            <% if log.metadata["source_email"].present? %>
              <% full_path = Rails.root.join("db/seeds/emails", log.metadata["source_email"]).to_s %>
              <%= link_to log.metadata["source_email"], email_path(EmlReader.encode_path(full_path)) %>
            <% end %>
          </td>
          <td>
            <% if log.field_changes.any? %>
              <ul>
                <% log.field_changes.each do |field, change| %>
                  <li><strong><%= field %></strong>: <%= change["from"].presence || "(empty)" %> &rarr; <%= change["to"] %></li>
                <% end %>
              </ul>
            <% end %>
          </td>
        </tr>
      <% end %>
    </tbody>
  </table>
<% else %>
  <p>No audit history yet.</p>
<% end %>

<p><%= link_to "Back to companies", companies_path %></p>
