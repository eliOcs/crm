<%# Support both local variable (from broadcast) and instance variable (from controller) %>
<% import = local_assigns[:active_import] || @active_import %>
<% imports_history = local_assigns[:recent_imports] || @recent_imports || [] %>

<div id="microsoft-import-status">
<% if import&.active? %>
  <div class="import-progress">
    <div class="import-progress__header">
      <span class="import-progress__status badge badge--<%= import.status %>">
        <%= import.status_label %>
      </span>
      <span class="import-progress__range"><%= import.time_range_label %></span>
    </div>

    <% if import.total_emails > 0 %>
      <div class="progress-bar">
        <div class="progress-bar__fill" style="width: <%= import.progress_percentage %>%"></div>
      </div>
      <div class="import-progress__stats">
        <span><%= t("microsoft_import.progress", processed: import.processed_emails, total: import.total_emails) %></span>
        <span><%= import.progress_percentage %>%</span>
      </div>
    <% else %>
      <div class="import-progress__counting">
        <%= t("microsoft_import.counting") %>
      </div>
    <% end %>

    <% if import.skipped_emails > 0 || import.failed_emails > 0 %>
      <div class="import-progress__details txt-subtle txt-sm">
        <% if import.skipped_emails > 0 %>
          <span><%= t("microsoft_import.skipped", count: import.skipped_emails) %></span>
        <% end %>
        <% if import.failed_emails > 0 %>
          <span><%= t("microsoft_import.failed", count: import.failed_emails) %></span>
        <% end %>
      </div>
    <% end %>

    <div class="import-progress__actions">
      <%= button_to t("common.cancel"),
            cancel_microsoft_import_settings_path(id: import.id),
            method: :delete,
            class: "btn btn--secondary btn--sm",
            data: { turbo_confirm: t("microsoft_import.cancel_confirm") } %>
    </div>
  </div>
<% else %>
  <%= form_with url: start_microsoft_import_settings_path, method: :post, class: "import-form" do |form| %>
    <div class="import-form__row">
      <%= form.select :time_range,
            options_for_select([
              [t("microsoft_import.time_ranges.3_months"), "3_months"],
              [t("microsoft_import.time_ranges.1_year"), "1_year"],
              [t("microsoft_import.time_ranges.3_years"), "3_years"]
            ], "1_year"),
            {},
            class: "select" %>
      <%= form.submit t("microsoft_import.start"), class: "btn btn--primary" %>
    </div>
  <% end %>

  <% if imports_history.present? %>
    <div class="import-history mar-t-lg">
      <h3 class="txt-sm txt-subtle mar-b-sm"><%= t("microsoft_import.history") %></h3>
      <ul class="import-history__list">
        <% imports_history.each do |hist_import| %>
          <li class="import-history__item">
            <span class="badge badge--<%= hist_import.status %>"><%= hist_import.status_label %></span>
            <span class="import-history__range"><%= hist_import.time_range_label %></span>
            <span class="import-history__stats txt-subtle">
              <%= t("microsoft_import.history_stats",
                    imported: hist_import.imported_emails,
                    skipped: hist_import.skipped_emails) %>
            </span>
            <span class="import-history__date txt-subtle">
              <%= time_ago_in_words(hist_import.completed_at || hist_import.created_at) %> <%= t("common.ago") %>
            </span>
          </li>
        <% end %>
      </ul>
    </div>
  <% end %>
<% end %>
</div>
