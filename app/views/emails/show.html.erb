<%= link_to t("emails.back"), emails_path, class: "back-link" %>

<div class="page-header">
  <h1 class="page-header__title"><%= @email[:subject].presence || t("emails.no_subject") %></h1>
</div>

<div class="email-card">
  <div class="email-card__meta">
    <dl>
      <dt><%= t("emails.fields.from") %></dt>
      <dd>
        <% if @email[:from] %>
          <%= @email[:from][:name] %> &lt;<%= @email[:from][:email] %>&gt;
        <% else %>
          <%= t("emails.unknown") %>
        <% end %>
      </dd>

      <dt><%= t("emails.fields.to") %></dt>
      <dd>
        <% if @email[:to].present? %>
          <% @email[:to].each do |recipient| %>
            <%= recipient[:name] %> &lt;<%= recipient[:email] %>&gt;<br>
          <% end %>
        <% else %>
          <%= t("emails.none") %>
        <% end %>
      </dd>

      <% if @email[:cc].present? %>
        <dt><%= t("emails.fields.cc") %></dt>
        <dd>
          <% @email[:cc].each do |recipient| %>
            <%= recipient[:name] %> &lt;<%= recipient[:email] %>&gt;<br>
          <% end %>
        </dd>
      <% end %>

      <dt><%= t("emails.fields.date") %></dt>
      <dd><%= @email[:date]&.strftime("%Y-%m-%d %H:%M:%S %Z") %></dd>

      <% file_attachments = @email[:attachments].select { |a| !a[:inline] } %>
      <% if file_attachments.any? %>
        <dt><%= t("emails.fields.attachments") %></dt>
        <dd>
          <ul>
            <% file_attachments.each do |att| %>
              <li>
                <%= link_to att[:filename], download_email_path(@encoded_path, index: att[:index]), data: { turbo: false } %>
                <small class="txt-muted">(<%= att[:content_type] %>, <%= number_to_human_size(att[:size]) %>)</small>
              </li>
            <% end %>
          </ul>
        </dd>
      <% end %>
    </dl>
  </div>

  <div class="email-card__body">
    <% if @email[:html_body].present? %>
      <%
        html_with_images = @email[:html_body].dup
        html_with_images.gsub!(/<style[^>]*>.*?<\/style>/mi, "")
        @email[:attachments].each do |att|
          next unless att[:content_id]
          cid = att[:content_id]
          filename = cid.split("@").first
          url = attachment_email_path(@encoded_path, cid: filename)
          html_with_images.gsub!("cid:#{cid}", url)
        end
      %>
      <%= sanitize html_with_images, tags: %w[p br div span a b i u strong em h1 h2 h3 h4 h5 h6 ul ol li table tr td th thead tbody img hr blockquote pre code], attributes: %w[href src alt style class] %>
    <% elsif @email[:body].present? %>
      <pre><%= @email[:body] %></pre>
    <% else %>
      <p class="txt-subtle"><%= t("emails.no_body") %></p>
    <% end %>
  </div>
</div>
